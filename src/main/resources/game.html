<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>YoutubeGuessr</title>
    <link rel="stylesheet" href="youtubeguessr.css">
</head>
<body>

<div id="game">

<div id="left">
<h3>{{game_name}}</h3>
<table id="user_table">
</table>
</div>

<div id="mid">
<div id="viddiv">
    <iframe width="810" height="540"
            src="//www.youtube.com/embed/?modestbranding=1&autohide=1&showinfo=0&controls=0&autoplay=1&rel=0
             &disablekb=1&fs=0&loop=1"
            frameborder="0" id="video"></iframe>
</div>

<button id="start_button" onclick="startClicked()">Start Game</button>

<form hidden="hidden" id="guess_form" action="javascript:;" onsubmit="guessSubmitted(this)">
    <label>
        Your guess:
        <input type="number" name="views">
    </label>
    <input type="submit"><br>
    <label id="countdown_label"></label><br>
    <label id="duration_label"></label><br>
    <label id="current_guess"></label>
</form>

<div id="results" hidden="hidden">
    <table id="guess_table">
    </table>
    <p id="actual_count"></p>
</div>
</div>

<div id="chat">
    <textarea id="chat_window" readonly="readonly" wrap="soft" disabled="disabled" rows="30"></textarea>
    <form action="javascript:;" onsubmit="chatSubmitted()">
        <input type="text" id="chat_input">
        <input type="submit" id="chat_submit">
    </form>
</div>

</div>

</body>
<script type="text/javascript">
    const id = "{{game_id}}";
    var username = "{{username}}";
    var webSocket = new WebSocket("ws://" + location.hostname + ":" + location.port + "/gamesocket");
    webSocket.onopen = function () {
        webSocket.send(JSON.stringify(
            {type: "connect", id: id, username: username}
        ))
    };

    webSocket.onmessage = function(message) {
        var data = JSON.parse(message.data);
        if (data.username != undefined) {
            username = data.username;
        }
        if (data.users != undefined) {
            const users = data.users;
            const userTable = document.getElementById("user_table");
            userTable.innerHTML = "";
            for (var i = 0; i < users.length; i++) {
                const user = users[i];
                var name = user.name;
                if (name == username) {
                    name += " *";
                }
                userTable.innerHTML += "<tr><td>" + name + "</td><td>" + user.points.toString() + "</td></tr>";
            }
        }
        if (data.type == "newVideo") {
            document.getElementById("current_guess").innerHTML = "";
            document.getElementById("results").setAttribute("hidden", "hidden");
            document.getElementById("start_button").setAttribute("hidden", "hidden");
            document.getElementById("guess_form").removeAttribute("hidden");
            const time = data.duration;
            const minutes = Math.floor(time / 60).toString();
            const seconds = time % 60;
            var secondsString;
            if (seconds < 10) {
                secondsString = "0" + seconds.toString();
            } else {
                secondsString = seconds.toString();
            }
            document.getElementById("duration_label").innerHTML = "Duration: " + minutes + ":" + secondsString;
            var url = data.url;
            if (url != null) {
                document.getElementById("video").setAttribute("src",
                    "//www.youtube.com/embed/" + url + "?modestbranding=1&autohide=1&showinfo=0&controls=0&autoplay=1&rel=0&disablekb=1&fs=0&loop=1");
            }
        }
        if (data.type == "updateCountdown") {
            document.getElementById("countdown_label").innerHTML = "Time: " + data.countdown.toString();
        }
        if (data.type == "score") {
            document.getElementById("results").removeAttribute("hidden");
            const guesses = data.guesses;
            const guessTable = document.getElementById("guess_table");
            guessTable.innerHTML = "";
            const closestUsers = data.closestUsers;
            Object.keys(guesses).forEach(function (username) {
                const guess = guesses[username];
                for (var i = 0; i < closestUsers.length; i++) {
                    if (username == closestUsers[i]) {
                        username += " ðŸ‘‘";
                    }
                }
                guessTable.innerHTML += "<tr><td>" + username + "</td><td>" + guess.toString() + "</td></tr>";
            });
            document.getElementById("actual_count").innerHTML = "Actual views: " + data.viewcount;
        }
        if (data.type == "chatMessage") {
            const chatMessage = data.message;
            var dataUsername = data.senderName;
            if (dataUsername == username) {
                dataUsername += " *";
            }
            document.getElementById("chat_window").textContent += dataUsername + ": " + chatMessage + "\n";
        }
    };

    function startClicked() {
        webSocket.send(JSON.stringify(
            {"type": "start"}
        ))
    }

    function guessSubmitted(form) {
        const views = form.views.value;
        form.views.value = null;
        webSocket.send(JSON.stringify(
            {"type": "guess", "views": views}
        ));
        document.getElementById("current_guess").innerHTML = "Current Guess: " + views.toString();
    }

    function chatSubmitted() {
        const message = document.getElementById("chat_input").value;
        webSocket.send(JSON.stringify(
            {"type": "chatMessage", "message": message}
        ));
        document.getElementById("chat_input").value = "";
        document.getElementById("chat_input").focus();
    }

</script>
</html>