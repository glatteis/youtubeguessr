<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <title>YoutubeGuessr</title>
</head>
<body>

<div class="container">
    <div class="row">
        <h3>{{game_name}}</h3>
    </div>
    <div class="row">
        <div class="col-sm-2"> <!-- User Overview !-->
            <table id="user_table" class="table table-striped">
                <thead class="thead-inverse"><tr><th>name</th><th>#</th></tr></thead>
            </table>
        </div>
        <div class="col-lg-9">
            <div class="row"> <!-- Video !-->
                <div id="viddiv" style="pointer-events: none;">
                    <iframe width="810" height="540"
                            src="//www.youtube.com/embed/?modestbranding=1&autohide=1&showinfo=0&controls=0&autoplay=1&rel=0
             &disablekb=1&fs=0&loop=1"
                            frameborder="0" id="video"></iframe>
                </div>
            </div>

            <div class="row"> <!-- Voting !-->
                <button class="btn btn-primary" id="start_button" onclick="startClicked()">Start Game</button>

                <form hidden="hidden" id="guess_form" action="javascript:;" onsubmit="guessSubmitted(this)">
                    <div class="input-group">
                        <span class="input-group-addon">Your guess: </span>
                        <input type="number" name="views">
                    </div>
                    <br>
                    <input type="submit" class="btn btn-primary" value="Guess"><br>
                    <label id="countdown_label"></label><br>
                    <label id="duration_label"></label><br>
                    <label id="current_guess"></label>
                </form>
                <div id="results" hidden="hidden">
                    <canvas id="score_canvas" width="810" height="200"></canvas>
                    <table class="table table-striped" id="guess_table"></table>
                </div>
            </div>
        </div>
        <div class="col-sm-1"> <!-- Chat !-->
            <div id="chat">
                <textarea id="chat_window" readonly="readonly" wrap="soft" disabled="disabled" rows="30"></textarea>
                <form action="javascript:;" onsubmit="chatSubmitted()">
                    <input type="text" id="chat_input">
                    <input type="submit" id="chat_submit">
                </form>
            </div>
        </div>

    </div>
</div>
</body>
<script src="js/jquery-3.2.0.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="scorecanvas.js"></script>
<script type="text/javascript">
    const id = "{{game_id}}";
    var username = "{{username}}";
    var webSocket = new WebSocket("ws://" + location.hostname + ":" + location.port + "/gamesocket");
    webSocket.onopen = function () {
        webSocket.send(JSON.stringify(
            {type: "connect", id: id, username: username}
        ));
    };

    webSocket.onmessage = function (message) {
        var data = JSON.parse(message.data);
        if (data.username !== undefined) {
            username = data.username;
        }
        if (data.users !== undefined) {
            const users = data.users;
            const userTable = $("#user_table")[0];
            userTable.innerHTML = "<thead><tr><th>Name</th><th>#</th></tr></thead>";
            for (var i = 0; i < users.length; i++) {
                const user = users[i];
                var name = user.name;
                if (name === username) {
                    name += " *";
                }
                userTable.innerHTML += "<tr><td>" + name + "</td><td>" + user.points.toString() + "</td></tr>";
            }
        }
        if (data.type === "newVideo") {
            $("#current_guess")[0].innerHTML = "";
            $("#results").hide();
            $("#start_button").hide();
            $("#guess_form").show();
            const time = data.duration;
            const minutes = Math.floor(time / 60).toString();
            const seconds = time % 60;
            var secondsString;
            if (seconds < 10) {
                secondsString = "0" + seconds.toString();
            } else {
                secondsString = seconds.toString();
            }
            $("#duration_label")[0].innerHTML = "Duration: " + minutes + ":" + secondsString;
            var url = data.url;
            if (url !== null) {
                $("#video")[0].setAttribute("src",
                    "//www.youtube.com/embed/" + url + "?modestbranding=1&autohide=1&showinfo=0&controls=0&autoplay=1&rel=0&disablekb=1&fs=0&loop=1");
            }
        }
        if (data.type === "updateCountdown") {
            $("#countdown_label")[0].innerHTML = "Time: " + data.countdown.toString();
        }
        if (data.type === "score") {
            $("#results").show();
            drawCanvas(data.guesses, data.viewcount, data.closestUsers);
            const guesses = data.guesses;
            const guessTable = $("#guess_table")[0];
            guessTable.innerHTML = "";
            const closestUsers = data.closestUsers;
            Object.keys(guesses).forEach(function (username) {
                const guess = guesses[username];
                for (var i = 0; i < closestUsers.length; i++) {
                    if (username === closestUsers[i]) {
                        username += " ðŸ‘‘";
                    }
                }
                guessTable.innerHTML += "<tr><td>" + username + "</td><td>" + guess.toString() + "</td></tr>";
            });
            //$("#actual_count")[0].innerHTML = "Actual views: " + data.viewcount;
        }
        if (data.type === "chatMessage") {
            const chatMessage = data.message;
            var dataUsername = data.senderName;
            if (dataUsername === username) {
                dataUsername += " *";
            }
            $("#chat_window").textContent += dataUsername + ": " + chatMessage + "\n";
        }
    };

    function startClicked() {
        webSocket.send(JSON.stringify(
            {"type": "start"}
        ))
    }

    function guessSubmitted(form) {
        const views = form.views.value;
        form.views.value = null;
        webSocket.send(JSON.stringify(
            {"type": "guess", "views": views}
        ));
        document.getElementById("current_guess").innerHTML = "Current Guess: " + views.toString();
    }

    function chatSubmitted() {
        const message = document.getElementById("chat_input").value;
        webSocket.send(JSON.stringify(
            {"type": "chatMessage", "message": message}
        ));
        document.getElementById("chat_input").value = "";
        document.getElementById("chat_input").focus();
    }
</script>

</html>